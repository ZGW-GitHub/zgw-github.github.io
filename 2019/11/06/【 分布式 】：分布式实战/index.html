<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>【 分布式 】：分布式实战 | 愆凡の博客</title><meta name="description" content="【 分布式 】：分布式实战"><meta name="author" content="愆凡"><meta name="copyright" content="愆凡"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/favicon.ico"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="https://fonts.googleapis.com" crossorigin="crossorigin"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta name="twitter:card" content="summary"><meta name="twitter:title" content="【 分布式 】：分布式实战"><meta name="twitter:description" content="【 分布式 】：分布式实战"><meta name="twitter:image" content="http://yoursite.com/img/avatar.png"><meta property="og:type" content="article"><meta property="og:title" content="【 分布式 】：分布式实战"><meta property="og:url" content="http://yoursite.com/2019/11/06/%E3%80%90%20%E5%88%86%E5%B8%83%E5%BC%8F%20%E3%80%91%EF%BC%9A%E5%88%86%E5%B8%83%E5%BC%8F%E5%AE%9E%E6%88%98/"><meta property="og:site_name" content="愆凡の博客"><meta property="og:description" content="【 分布式 】：分布式实战"><meta property="og:image" content="http://yoursite.com/img/avatar.png"><script src="https://cdn.jsdelivr.net/npm/js-cookie/dist/js.cookie.min.js"></script><script>const autoChangeMode = '1'
var t = Cookies.get("theme")
if (autoChangeMode == '1'){
  const isDarkMode = window.matchMedia("(prefers-color-scheme: dark)").matches
  const isLightMode = window.matchMedia("(prefers-color-scheme: light)").matches
  const isNotSpecified = window.matchMedia("(prefers-color-scheme: no-preference)").matches
  const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

  if (t === undefined){
    if (isLightMode) activateLightMode()
    else if (isDarkMode) activateDarkMode()
    else if (isNotSpecified || hasNoSupport){
      console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
      now = new Date();
      hour = now.getHours();
      isNight = hour < 6 || hour >= 18
      isNight ? activateDarkMode() : activateLightMode()
  }
  } else if (t == 'light') activateLightMode()
  else activateDarkMode()

} else if (autoChangeMode == '2'){
  now = new Date();
  hour = now.getHours();
  isNight = hour < 6 || hour >= 18
  if(t === undefined) isNight? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode() 
} else {
  if ( t == 'dark' ) activateDarkMode()
  else if ( t == 'light') activateLightMode()
}

function activateDarkMode(){
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null){
    document.querySelector('meta[name="theme-color"]').setAttribute('content','#000')
  }
}
function activateLightMode(){
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null){
  document.querySelector('meta[name="theme-color"]').setAttribute('content','#fff')
  }
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="canonical" href="http://yoursite.com/2019/11/06/%E3%80%90%20%E5%88%86%E5%B8%83%E5%BC%8F%20%E3%80%91%EF%BC%9A%E5%88%86%E5%B8%83%E5%BC%8F%E5%AE%9E%E6%88%98/"><link rel="prev" title="【 MySQL 系列 】：MySQL 实战" href="http://yoursite.com/2019/11/06/%E3%80%90%20MySQL%20%E7%B3%BB%E5%88%97%20%E3%80%91%EF%BC%9AMySQL%20%E5%AE%9E%E6%88%98/"><link rel="next" title="【 服务器 】" href="http://yoursite.com/2019/11/05/%E3%80%90%20%E6%9C%8D%E5%8A%A1%E5%99%A8%20%E3%80%91/"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"cookieDomain":"https://blog.notuptoyou.site","msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    title: 'Snackbar.bookmark.title',
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天',
  runtime: true,
  copyright: undefined,
  ClickShowText: undefined,
  medium_zoom: false,
  fancybox: true,
  Snackbar: undefined,
  baiduPush: false,
  highlightCopy: true,
  highlightLang: true,
  highlightShrink: false,
  isFontAwesomeV5: false
  
}</script><script>var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false
}</script><meta name="generator" content="Hexo 4.2.0"></head><body><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="/img/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">50</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">标签</div><div class="length_num">14</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">分类</div><div class="length_num">12</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> About</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> List</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> Music</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> Movie</span></a></li></ul></div></div></div></div><i class="fa fa-arrow-right on" id="toggle-sidebar" aria-hidden="true">     </i><div id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#分布式-ID"><span class="toc-number">1.</span> <span class="toc-text">分布式 ID</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#一、基于数据库"><span class="toc-number">1.1.</span> <span class="toc-text">一、基于数据库</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#水平扩展改进"><span class="toc-number">1.1.0.1.</span> <span class="toc-text">水平扩展改进</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#二、本地-UUID-生成"><span class="toc-number">1.2.</span> <span class="toc-text">二、本地 UUID 生成</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#三、采用本地时间"><span class="toc-number">1.3.</span> <span class="toc-text">三、采用本地时间</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#四、Twitter-雪花算法"><span class="toc-number">1.4.</span> <span class="toc-text">四、Twitter 雪花算法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#五、参考资料"><span class="toc-number">1.5.</span> <span class="toc-text">五、参考资料</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#分布式事务"><span class="toc-number">2.</span> <span class="toc-text">分布式事务</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#一、分布式事务相关理论"><span class="toc-number">2.1.</span> <span class="toc-text">一、分布式事务相关理论</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1、CAP-定理"><span class="toc-number">2.1.1.</span> <span class="toc-text">1、CAP 定理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#a、分区容错"><span class="toc-number">2.1.1.1.</span> <span class="toc-text">a、分区容错</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#b、可用性"><span class="toc-number">2.1.1.2.</span> <span class="toc-text">b、可用性</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#c、一致性"><span class="toc-number">2.1.1.3.</span> <span class="toc-text">c、一致性</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#d、一致性和可用性的矛盾："><span class="toc-number">2.1.1.4.</span> <span class="toc-text">d、一致性和可用性的矛盾：</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2、Base-理论"><span class="toc-number">2.1.2.</span> <span class="toc-text">2、Base 理论</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#a、Basically-Available（基本可用）"><span class="toc-number">2.1.2.1.</span> <span class="toc-text">a、Basically Available（基本可用）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#b、Soft-state（软状态）"><span class="toc-number">2.1.2.2.</span> <span class="toc-text">b、Soft state（软状态）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#c、Eventually-consistent（最终一致性）"><span class="toc-number">2.1.2.3.</span> <span class="toc-text">c、Eventually consistent（最终一致性）</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#二、分布式事务的解决方案"><span class="toc-number">2.2.</span> <span class="toc-text">二、分布式事务的解决方案</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1、基于-XA-协议的两阶段提交"><span class="toc-number">2.2.1.</span> <span class="toc-text">1、基于 XA 协议的两阶段提交</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#二阶段提交协议："><span class="toc-number">2.2.1.1.</span> <span class="toc-text">二阶段提交协议：</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2、TCC-补偿机制"><span class="toc-number">2.2.2.</span> <span class="toc-text">2、TCC 补偿机制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3、消息最终一致性"><span class="toc-number">2.2.3.</span> <span class="toc-text">3、消息最终一致性</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#分布式锁"><span class="toc-number">3.</span> <span class="toc-text">分布式锁</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#一、基于-Redis-的分布式锁"><span class="toc-number">3.1.</span> <span class="toc-text">一、基于 Redis 的分布式锁</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1、实现思想"><span class="toc-number">3.1.1.</span> <span class="toc-text">1、实现思想</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2、实现"><span class="toc-number">3.1.2.</span> <span class="toc-text">2、实现</span></a></li></ol></li></ol></li></ol></div></div></div><div id="body-wrap"><div class="post-bg" id="nav" style="background-image: url(/img/post.jpg)"><div id="page-header"><span class="pull_left" id="blog_name"><a class="blog_title" id="site-name" href="/">愆凡の博客</a></span><span class="toggle-menu pull_right close"><a class="site-page"><i class="fa fa-bars fa-fw" aria-hidden="true"></i></a></span><span class="pull_right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> About</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> List</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> Music</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> Movie</span></a></li></ul></div></div></span></div><div id="post-info"><div id="post-title"><div class="posttitle">【 分布式 】：分布式实战</div></div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 发表于 2019-11-06<span class="post-meta__separator">|</span><i class="fa fa-history fa-fw" aria-hidden="true"></i> 更新于 2020-03-21</time><span class="post-meta__separator">|</span><span><i class="fa fa-inbox post-meta__icon fa-fw" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F/">分布式</a></span><div class="post-meta-wordcount"><div class="post-meta-pv-cv"><i class="fa fa-eye post-meta__icon fa-fw" aria-hidden="true"> </i><span>阅读量:</span><span id="busuanzi_value_page_pv"></span></div></div></div></div></div><main class="layout_post" id="content-inner"><article id="post"><div id="article-container"><h1 id="分布式-ID"><a href="#分布式-ID" class="headerlink" title="分布式 ID"></a>分布式 ID</h1><blockquote>
<p>一个唯一的 ID 在系统中是非常重要的一个业务属性，其中包括一些如订单 ID，消息 ID，会话 ID，他们都有一些共有的特性：</p>
<ul>
<li>全局唯一</li>
<li>趋势递增</li>
</ul>
</blockquote>
<blockquote>
<p>全局唯一很好理解，目的就是唯一标识某个次请求，某个业务。</p>
<p>通常有以下几种方案：</p>
<ul>
<li>基于数据库</li>
<li>本地 UUID 生成</li>
<li>采用本地时间</li>
<li>Twitter 雪花算法</li>
</ul>
</blockquote>
<p><img src="/" alt="常用的分布式ID方案" class="lazyload" data-src="%E3%80%90%20%E5%88%86%E5%B8%83%E5%BC%8F%20%E3%80%91%EF%BC%9A%E5%88%86%E5%B8%83%E5%BC%8F%E5%AE%9E%E6%88%98/%E5%B8%B8%E7%94%A8%E7%9A%84%E5%88%86%E5%B8%83%E5%BC%8FID%E6%96%B9%E6%A1%88.png"></p>
<h2 id="一、基于数据库"><a href="#一、基于数据库" class="headerlink" title="一、基于数据库"></a>一、基于数据库</h2><p> 可以利用 <code>MySQL</code> 中的自增属性 <code>auto_increment</code> 来生成全局唯一 ID，也能保证趋势递增。 但这种方式太依赖 DB，如果数据库挂了那就非常容易出问题。</p>
<h4 id="水平扩展改进"><a href="#水平扩展改进" class="headerlink" title="水平扩展改进"></a>水平扩展改进</h4><p>但也有改进空间，可以将数据库水平拆分，如果拆为了两个库 A 库和 B 库。 A 库的递增方式可以是 <code>0 ,2 ,4 ,6</code>。B 库则是 <code>1 ,3 ,5 ,7</code>。这样的方式可以提高系统可用性，并且 ID 也是趋势递增的。</p>
<p>缺陷：</p>
<ul>
<li>想要扩容增加性能变的困难，之前已经定义好了 A B 库递增的步数，新加的数据库不好加入进来，水平扩展困难。</li>
<li>也是强依赖与数据库，并且如果其中一台挂掉了那就不是绝对递增了。</li>
</ul>
<h2 id="二、本地-UUID-生成"><a href="#二、本地-UUID-生成" class="headerlink" title="二、本地 UUID 生成"></a>二、本地 UUID 生成</h2><p>还可以采用 <code>UUID</code> 的方式生成唯一 ID，由于是在本地生成没有了网络之类的消耗，所有效率非常高。</p>
<p>缺陷：</p>
<ul>
<li>生成的 ID 是无序性的，不能做到趋势递增。</li>
<li>由于是字符串并且不是递增，所以不太适合用作主键。</li>
</ul>
<h2 id="三、采用本地时间"><a href="#三、采用本地时间" class="headerlink" title="三、采用本地时间"></a>三、采用本地时间</h2><p>这种做法非常简单，可以利用本地的毫秒数加上一些业务 ID 来生成唯一ID，这样可以做到趋势递增，并且是在本地生成效率也很高。</p>
<p>缺陷：</p>
<ul>
<li>当并发量足够高的时候<strong>唯一性</strong>就不能保证了。</li>
</ul>
<h2 id="四、Twitter-雪花算法"><a href="#四、Twitter-雪花算法" class="headerlink" title="四、Twitter 雪花算法"></a>四、Twitter 雪花算法</h2><p> 可以基于 <code>Twitter</code> 的 <code>Snowflake</code> 算法来实现。它主要是一种划分命名空间的算法，将生成的 ID 按照机器、时间等来进行标志。 </p>
<h2 id="五、参考资料"><a href="#五、参考资料" class="headerlink" title="五、参考资料"></a>五、参考资料</h2><p><a href="https://github.com/Snailclimb/JavaGuide/blob/master/docs/system-design/micro-service/分布式id生成方案总结.md" target="_blank" rel="noopener">GitHub 文章</a></p>
<h1 id="分布式事务"><a href="#分布式事务" class="headerlink" title="分布式事务"></a>分布式事务</h1><h2 id="一、分布式事务相关理论"><a href="#一、分布式事务相关理论" class="headerlink" title="一、分布式事务相关理论"></a>一、分布式事务相关理论</h2><h3 id="1、CAP-定理"><a href="#1、CAP-定理" class="headerlink" title="1、CAP 定理"></a>1、CAP 定理</h3><blockquote>
<p>CAP 定理是在 1998 年加州大学的计算机科学家 Eric Brewer （埃里克.布鲁尔）提出，分布式系统有三个指标：</p>
<ul>
<li>Consistency        一致性</li>
<li>Availability        可用性</li>
<li>Partition tolerance        分区容错</li>
</ul>
<p>Eric Brewer 说，这三个指标不可能同时做到。这个结论就叫做 CAP 定理。</p>
</blockquote>
<h4 id="a、分区容错"><a href="#a、分区容错" class="headerlink" title="a、分区容错"></a>a、分区容错</h4><ul>
<li><p>大多数分布式系统都分布在多个子网络。每个子网络就叫做一个区（partition）。</p>
</li>
<li><p>分区容错的意思是：区间通信可能失败。</p>
</li>
<li><p>一般来说，分区容错无法避免，因此可以认为 CAP 的 P 总是成立。CAP 定理告诉我们， 剩下的 C 和 A 无法同时做到。</p>
</li>
</ul>
<h4 id="b、可用性"><a href="#b、可用性" class="headerlink" title="b、可用性"></a>b、可用性</h4><ul>
<li>意思是只要收到用户的请求，服务器就必须给出回应。</li>
</ul>
<h4 id="c、一致性"><a href="#c、一致性" class="headerlink" title="c、一致性"></a>c、一致性</h4><ul>
<li>意思是，写操作之后的读操作，必须返回该值。</li>
</ul>
<h4 id="d、一致性和可用性的矛盾："><a href="#d、一致性和可用性的矛盾：" class="headerlink" title="d、一致性和可用性的矛盾："></a>d、一致性和可用性的矛盾：</h4><ul>
<li>一致性和可用性，为什么不可能同时成立？答案很简单，因为可能通信失败（即出现分 区容错）。</li>
<li>如果保证 G2 的一致性，那么 G1 必须在写操作时，锁定 G2 的读操作和写操作。只有数据同步后，才能重新开放读写。锁定期间，G2 不能读写，此时 G2 没有可用性。</li>
<li>如果保证 G2 的可用性，那么势必不能锁定 G2，但此时一致性不成立。</li>
<li>综上所述，G2 无法同时做到一致性和可用性。系统设计时只能选择一个目标。如果追求一致性，那么无法保证所有节点的可用性；如果追求所有节点的可用性，那就没法做到 一致性。</li>
</ul>
<h3 id="2、Base-理论"><a href="#2、Base-理论" class="headerlink" title="2、Base 理论"></a>2、Base 理论</h3><blockquote>
<p>BASE：是下面三个短语的缩写：</p>
<ul>
<li>Basically Available（基本可用）</li>
<li>Soft state（软状态）</li>
<li>Eventually consistent（最终一致性）</li>
</ul>
<p>BASE 理论是对 CAP 中一致性和可用性权衡的结果，其来源于对大型互联网分布式实践的总结，是基于 CAP 定理逐步演化而来的。其核心思想是：</p>
<blockquote>
<p>既是无法做到强一致性（Strong consistency），但每个应用都可以根据自身的业务特点，采用适当的方式来使系统达到最终一致性（Eventual consistency）。</p>
</blockquote>
</blockquote>
<h4 id="a、Basically-Available（基本可用）"><a href="#a、Basically-Available（基本可用）" class="headerlink" title="a、Basically Available（基本可用）"></a>a、Basically Available（基本可用）</h4><p>什么是基本可用呢？假设系统，出现了不可预知的故障，但还是能用，相比较正常的系统而言：</p>
<ol>
<li><p>响应时间上的损失：</p>
<p> 正常情况下的搜索引擎 0.5 秒即返回给用户结果，而基本可用的 搜索引擎可以在 1 秒作用返回结果。 </p>
</li>
<li><p>功能上的损失：</p>
<p> 在一个电商网站上，正常情况下，用户可以顺利完成每一笔订单，但是到了大促期间，为了保护购物系统的稳定性，部分消费者可能会被引导到一个降级页面。</p>
</li>
</ol>
<h4 id="b、Soft-state（软状态）"><a href="#b、Soft-state（软状态）" class="headerlink" title="b、Soft state（软状态）"></a>b、Soft state（软状态）</h4><p>什么是软状态呢？相对于原子性而言，要求多个节点的数据副本都是一致的，这是一种 “硬状态”。</p>
<p>软状态指的是：允许系统中的数据存在中间状态，并认为该状态不影响系统的整体可用性，即：允许系统在多个不同节点的数据副本存在数据延时。</p>
<h4 id="c、Eventually-consistent（最终一致性）"><a href="#c、Eventually-consistent（最终一致性）" class="headerlink" title="c、Eventually consistent（最终一致性）"></a>c、Eventually consistent（最终一致性）</h4><p>系统能够保证在没有其他新的更新操作的情况下，数据最终一定能够达到一致的状态，因此所有客户端对系统的数据访问最终都能够获取到最新的值。 </p>
<h2 id="二、分布式事务的解决方案"><a href="#二、分布式事务的解决方案" class="headerlink" title="二、分布式事务的解决方案"></a>二、分布式事务的解决方案</h2><h3 id="1、基于-XA-协议的两阶段提交"><a href="#1、基于-XA-协议的两阶段提交" class="headerlink" title="1、基于 XA 协议的两阶段提交"></a>1、基于 XA 协议的两阶段提交</h3><blockquote>
<p>XA 协议：</p>
<ul>
<li>全局事务管理器与资源管理器的接口。</li>
<li>XA 是由 X/Open 组织提出的分布式事务规范。该规范主要定义了全局事务管理器和局部资源管理器之间的接口。</li>
<li>主流的数据库产品都实现了 XA 接口。</li>
<li>XA 接口是一个双向的系统接口，在事务管理器以及多个资源管理器之间作为通信桥梁。之所以需要 XA 是因为在分布式系统中从理论上讲两台机器是无法达到一致性状态的，因此引入一个单点进行协调。由全局事务管理器管理和协调的事务可以跨越多个资源和进程。全局事务管理器一般使用 XA 二阶段协议与数据库进行交互。</li>
</ul>
<p>由下图可知，XA 规范中分布式事务由 AP、RM、TM 组成。</p>
<ul>
<li><p>应用程序 ( Application Program ，简称 AP )：</p>
<p>  AP 定义事务边界（定义事务开始和结束）并访问事务边界内的资源。</p>
</li>
<li><p>资源管理器 ( Resource Manager，简称 RM )：</p>
<p>  Rm 管理计算机共享的资源，许多软件都可以去访问这些资源，资源包含比如：数据库、文件系统、打印机服务器等。</p>
</li>
<li><p>事务管理器 ( Transaction Manager ，简称 TM )：</p>
<p>  负责管理全局事务，分配事务唯一标识，监控事务的执行进度，并负责事务的提交、回滚、失败恢复等。</p>
</li>
</ul>
</blockquote>
<p><img src="/" alt="XA 规范" class="lazyload" data-src="%E3%80%90%20%E5%88%86%E5%B8%83%E5%BC%8F%20%E3%80%91%EF%BC%9A%E5%88%86%E5%B8%83%E5%BC%8F%E5%AE%9E%E6%88%98/XA%20%E8%A7%84%E8%8C%83.png"></p>
<h4 id="二阶段提交协议："><a href="#二阶段提交协议：" class="headerlink" title="二阶段提交协议："></a>二阶段提交协议：</h4><p>第一阶段 TM 要求所有的 RM 准备提交对应的事务分支，询问 RM 是否有能力保证成功的提交事务分支，RM 根据自己的情况，如果判断自己进行的工作可以被提交，那就就对工作内容进行持久化，并给 TM 回执 OK ；否者给 TM 的回执 NO。RM 在发送了否定答复并回滚了已经的工作后，就可以丢弃这个事务分支信息了。</p>
<p>第二阶段 TM 根据阶段1各个 RM prepare 的结果，决定是提交还是回滚事务。如果所有的 RM 都 prepare 成功，那么 TM 通知所有的 RM 进行提交；如果有 RM prepare 回执 NO 的话，则 TM 通知所有 RM 回滚自己的事务分支。</p>
<p>也就是 TM 与 RM 之间是通过两阶段提交协议进行交互的。</p>
<p>优点： 尽量保证了数据的强一致，适合对数据强一致要求很高的关键领域。（其实也不能 100% 保证强一致）</p>
<p>缺点： 实现复杂，牺牲了可用性，对性能影响较大，不适合高并发高性能场景。</p>
<h3 id="2、TCC-补偿机制"><a href="#2、TCC-补偿机制" class="headerlink" title="2、TCC 补偿机制"></a>2、TCC 补偿机制</h3><blockquote>
<p>TCC 其实就是采用的补偿机制，其核心思想是：针对每个操作，都要注册一个与其对应的确认和补偿（撤销）操作。它分为三个阶段：</p>
<ul>
<li>Try 阶段主要是对业务系统做检测及资源预留。</li>
<li>Confirm 阶段主要是对业务系统做确认提交，Try 阶段执行成功并开始执行 Confirm 阶段时，默认 Confirm 阶段是不会出错的。即：只要 Try 成功，Confirm 一定成功。</li>
<li>Cancel 阶段主要是在业务执行错误，需要回滚的状态下执行的业务取消，预留资源释放。</li>
</ul>
<p>优点： 相比两阶段提交，可用性比较强</p>
<p>缺点： 数据的一致性要差一些。TCC 属于应用层的一种补偿方式，所以需要程序员在实现的时候多写很多补偿的代码，在一些场景中，一些业务流程可能用 TCC 不太好定义及处理。</p>
</blockquote>
<p><img src="/" alt="TCC 补偿机制" class="lazyload" data-src="%E3%80%90%20%E5%88%86%E5%B8%83%E5%BC%8F%20%E3%80%91%EF%BC%9A%E5%88%86%E5%B8%83%E5%BC%8F%E5%AE%9E%E6%88%98/TCC%20%E8%A1%A5%E5%81%BF%E6%9C%BA%E5%88%B6.png"></p>
<p>例如：A 要向 B 转账，思路大概是： </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">我们有一个本地方法，里面依次调用</span><br><span class="line">1、首先在 Try 阶段，要先调用远程接口把 B 和 A 的钱给冻结起来。</span><br><span class="line">2、在 Confirm 阶段，执行远程调用的转账的操作，转账成功进行解冻。   </span><br><span class="line">3、如果第 2 步执行成功，那么转账成功，如果第二步执行失败，则调用远程冻结接口对应的解冻方法 (Cancel)。</span><br></pre></td></tr></table></figure>

<h3 id="3、消息最终一致性"><a href="#3、消息最终一致性" class="headerlink" title="3、消息最终一致性"></a>3、消息最终一致性</h3><blockquote>
<p>消息最终一致性应该是业界使用最多的，其核心思想是：</p>
<ul>
<li>将分布式事务拆分成本地事务进行处理。</li>
</ul>
<p>我们可以从下面的流程图中看出其中的一些细节： </p>
</blockquote>
<p><img src="/" alt="消息最终一致性" class="lazyload" data-src="%E3%80%90%20%E5%88%86%E5%B8%83%E5%BC%8F%20%E3%80%91%EF%BC%9A%E5%88%86%E5%B8%83%E5%BC%8F%E5%AE%9E%E6%88%98/%E6%B6%88%E6%81%AF%E6%9C%80%E7%BB%88%E4%B8%80%E8%87%B4%E6%80%A7.png"></p>
<p>基本思路就是：</p>
<p>消息生产方，需要额外建一个消息表，并记录消息发送状态。消息表和业务数据要在一个事务里提交，也就是说他们要在一个数据库里面。然后消息会经过 MQ 发送到消息的消费方。如果消息发送失败，会进行重试发送。</p>
<p>消息消费方，需要处理这个消息，并完成自己的业务逻辑。此时如果本地事务处理成功，表明已经处理成功了，如果处理失败，那么就会重试执行。如果是业务上面的失败，可以给生产方发送一个业务补偿消息，通知生产方进行回滚等操作。</p>
<p>生产方和消费方定时扫描本地消息表，把还没处理完成的消息或者失败的消息再发送一 遍。如果有靠谱的自动对账补账逻辑，这种方案还是非常实用的。</p>
<p>优点： 一种非常经典的实现，避免了分布式事务，实现了最终一致性。</p>
<p>缺点： 消息表会耦合到业务系统中，如果没有封装好的解决方案，会有很多杂活需要处理。</p>
<h1 id="分布式锁"><a href="#分布式锁" class="headerlink" title="分布式锁"></a>分布式锁</h1><blockquote>
<p>有多种实现：</p>
<ul>
<li>基于 DB 的唯一索引</li>
<li>基于 ZK 的临时有序节点</li>
<li>基于 Redis 的 <code>NX EX</code> 参数</li>
</ul>
</blockquote>
<h2 id="一、基于-Redis-的分布式锁"><a href="#一、基于-Redis-的分布式锁" class="headerlink" title="一、基于 Redis 的分布式锁"></a>一、基于 Redis 的分布式锁</h2><h3 id="1、实现思想"><a href="#1、实现思想" class="headerlink" title="1、实现思想"></a>1、实现思想</h3><blockquote>
<p>利用 redis set key 时的一个 NX 参数，来保证在 key 不存在时写入成功。并加上 EX 参数，让 key 在超时之后自动删除。</p>
</blockquote>
<h3 id="2、实现"><a href="#2、实现" class="headerlink" title="2、实现"></a>2、实现</h3><p><strong>单机 Redis 实现分布式锁：</strong></p>
<ul>
<li><a href="https://wudashan.cn/2017/10/23/Redis-Distributed-Lock-Implement/" target="_blank" rel="noopener">使用第三方开源组件 Jedis 实现Redis客户端，且只考虑 Redis 服务端单机部署的场景。</a></li>
</ul>
<p><strong>Redis 集群实现分布式锁：</strong></p>
<ul>
<li>借助 redisson（这是 Redis 官方提供的 Java 组件 ）</li>
</ul>
</div><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">愆凡</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://yoursite.com/2019/11/06/%E3%80%90%20%E5%88%86%E5%B8%83%E5%BC%8F%20%E3%80%91%EF%BC%9A%E5%88%86%E5%B8%83%E5%BC%8F%E5%AE%9E%E6%88%98/">http://yoursite.com/2019/11/06/%E3%80%90%20%E5%88%86%E5%B8%83%E5%BC%8F%20%E3%80%91%EF%BC%9A%E5%88%86%E5%B8%83%E5%BC%8F%E5%AE%9E%E6%88%98/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://yoursite.com" target="_blank">愆凡の博客</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="/img/avatar.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"/><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js"></script></div></div><div class="post-reward"><a class="reward-button button--primary button--animated"> <i class="fa fa-qrcode"></i> 打赏<div class="reward-main"><ul class="reward-all"><li class="reward-item"><img class="lazyload post-qr-code__img" src="/img/wechat.jpg" alt="微信"/><div class="post-qr-code__desc">微信</div></li><li class="reward-item"><img class="lazyload post-qr-code__img" src="/img/alipay.jpg" alt="支付寶"/><div class="post-qr-code__desc">支付寶</div></li></ul></div></a></div><nav class="pagination_post" id="pagination"><div class="prev-post pull_left"><a href="/2019/11/06/%E3%80%90%20MySQL%20%E7%B3%BB%E5%88%97%20%E3%80%91%EF%BC%9AMySQL%20%E5%AE%9E%E6%88%98/"><img class="prev_cover lazyload" data-src="/img/post.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">【 MySQL 系列 】：MySQL 实战</div></div></a></div><div class="next-post pull_right"><a href="/2019/11/05/%E3%80%90%20%E6%9C%8D%E5%8A%A1%E5%99%A8%20%E3%80%91/"><img class="next_cover lazyload" data-src="/img/post.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">【 服务器 】</div></div></a></div></nav></article></main><footer id="footer" data-type="color"><div id="footer-wrap"><div class="copyright">&copy;2020 By 愆凡</div><div class="framework-info"><span>驱动 </span><a href="https://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 </span><a href="https://github.com/jerryc127/hexo-theme-butterfly" target="_blank" rel="noopener"><span>Butterfly</span></a></div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><i class="fa fa-book" id="readmode" title="阅读模式"></i><i class="fa fa-plus" id="font_plus" title="放大字体"></i><i class="fa fa-minus" id="font_minus" title="缩小字体"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="简繁转换" target="_self">簡</a><i class="darkmode fa fa-moon-o" id="darkmode" title="夜间模式"></i></div><div id="rightside-config-show"><div id="rightside_config" title="设置"><i class="fa fa-cog" aria-hidden="true"></i></div><i class="fa fa-list-ul close" id="mobile-toc-button" title="目录" aria-hidden="true"></i><i class="fa fa-arrow-up" id="go-up" title="回到顶部" aria-hidden="true"></i></div></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@latest/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/lazysizes@latest/lazysizes.min.js" async=""></script></body></html>